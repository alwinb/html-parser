<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tree Builder Test Page</title>
  <link rel="stylesheet" href="style/base.css">
  <link rel="stylesheet" href="style/tree.css">
  <script src="./scripts/console.js"></script>
</head>
<body>

<script>
  window.console = new Console ()
  document.body.append (console.elem)
  window.addEventListener ('error', evt => console.errorHandler (evt), true)
</script>

<script src="../dist/html.js"></script>
<script src="../dist/domex.min.js"></script>
<script src="scripts/samples.js"></script>

<script>(()=>{

  const log = console.log.bind (console)
  const { html, domex: { domex, DomEx, Domex } } = modules
  const { defineProperty:define } = Object
  const T = html.tokenTypes

  // For debugging
  define (Object.prototype, Symbol.toStringTag, {
    get: function () { return this.constructor.name }
  })

  // DOM tools
  const htmlns = 'http://www.w3.org/1999/xhtml'
  const byId = document.getElementById.bind (document)
  const $ = name => document.createElement (name)
  const setProps = (el, props) => {
    for (let k in props) el.setAttribute (k, props[k])
  }

  // native HTML parser
  function nativeParse (input) {
    return new DOMParser () .parseFromString (input, 'text/html')
  }


  // Main
  // ----

  const objectKey = Symbol ()
  const samples = window ['html-samples']

  const ui = domex `

    li@tab.-button [data-key=$]
      > "Sample " + $;

    ul@tabs
      > @tab*;

    main@main
      > h1 "HTML Parser"
      + p "This is a test page for the HTML parser,"
      + @tabs#tabs ~samples
      + textarea#input + button#submit "Run"
      + div#view1 "Browser"
      + div#view2 "Html Parser";
    
    @main
  `

  function main () {

    document.body.append (ui.render ({ samples }) .elem)

    // makeTabs (samples)
    showSample (samples[0])

    const submit = byId ('submit')
    
    submit .addEventListener ('click', evt => {
      showSample (input.value)
    })

    document.addEventListener ('click', evt => {
      if (objectKey in evt.target) {
        log (evt.target [objectKey])
        window.$ = evt.target [objectKey]
      }
      if ('key' in evt.target.dataset)
        showSample (samples [+evt.target.dataset.key])

    })
    
    window.addEventListener ('keydown', evt => {
      if (evt.key === 'Enter' && evt.ctrlKey || evt.metaKey)
        showSample (input.value)
    })
    
    input.focus ()
  }

  setTimeout (main)

  // OK lets create the tree
  // MDN: In addition, every kind of DOM node is represented by an interface based on Node. These include Attr, CharacterData (which Text, Comment, and CDATASection are all based on), ProcessingInstruction, DocumentType, Notation, Entity, and EntityReference.

  function showSample (sample) {
    window.console.clear ()
    const [input, view1, view2] = ['input', 'view1', 'view2'] .map (byId)
    input.value = sample
    view1.innerHTML = view2.innerHTML = ''
    
    const nativeResult = nativeParse (sample)
    const result = html.parse (sample)

    view1.append ('native', showTree (nativeResult))
    view2.append ('parser', showTree (result))

    
    const p1 = print (nativeResult)
    const p2 = print (result)
    if (p1 !== p2) {
      console.error ('test failed', sample)
      console.log (p1, p2)
    }
  }

  function showTree (domNode) {
    let elem, label, clss

    if (domNode instanceof Text) {
      clss = (/^\s*$/.test (domNode.data)) ? 'space' : 'text'
      elem = $('span')
      elem.append (domNode.data)
      elem.className = clss
      elem[objectKey] = domNode
      return elem
    }
    if (typeof domNode === 'string') {
      clss = (/^\s*$/.test (domNode)) ? 'space' : 'text'
      elem = $('span')
      elem.append (domNode)
      elem.className = clss
      elem[objectKey] = domNode
      return elem
    }

    elem = $('div')
    if (domNode instanceof Document || domNode instanceof html.Document)
      label = '#document'

    else if (domNode instanceof Comment || domNode[0] === T.Comment)
      label = '<!-->'

    else if (domNode instanceof Element || domNode instanceof html.Node || domNode instanceof html.Leaf) {
      label = (domNode.tagName||domNode.name).toLowerCase ()
      if (domNode.namespaceURI && domNode.namespaceURI !== htmlns)
        label = domNode.namespaceURI.split('/').pop () + ':' + label
    }

    // log (domNode.__proto__)
    elem.append (label)
    elem[objectKey] = domNode.frame ? _frameInfo (domNode.frame) : domNode
    
    if (clss) elem.classList.add(clss)
    let ul; elem.append ((ul = $('div')))
    ul.className = 'children'

    const children = domNode instanceof HTMLTemplateElement ?
      domNode.content.childNodes : domNode.childNodes || domNode.children || []
    for (let x of children) {
      ul.append (showTree (x))
    }
    return elem
  }
  
  function _frameInfo ({ node, flags, closable, allowed, openable, openFor = 0n, paths }) {
    return {
      name: node.name,
      flags: html.printInfo (flags),
      closable: html.printInfo (closable),
      openable: html.printInfo (openable),
      allowed: html.printInfo (allowed),
      openFor: html.printInfo (openFor),
      paths
    }
  }
  
  // Serialise Test Result
  // ---------------------

  function print (node) {
    return [... _print (node)] .join ('')
  }

  function* _print (node, depth=0) {
    // UGH need to coalesce text nodes
    let indent = ''
    for (let i=0; i<depth; i++) indent += '  '
    if (typeof node === 'string')
      yield `| ${indent}"${node}"\n`

    else if (node instanceof Text)
      yield `| ${indent}"${node.data}"\n`

    else if (node instanceof html.Node) {
      yield `| ${indent}<${node.name}>\n`
      // TODO also print attrs, and coalesce text nodes
      for (let child of node.children) yield* _print (child, depth+1)
    }

    else if (node instanceof Element) {
      yield `| ${indent}<${node.tagName.toLowerCase ()}>\n`
      // TODO also print attrs, and coalesce text nodes
      for (let child of node.childNodes) yield* _print (child, depth+1)
    }

    else if (node instanceof html.Leaf) {
      yield `| ${indent}<${node.name}>\n`
      // TODO also print attrs, and add quotes around text
    }

    else if (node instanceof html.Document)
      for (let child of node.children) yield* _print (child, depth)

    else if (node instanceof Document)
      for (let child of node.childNodes) yield* _print (child, depth)
  }
  
  
  

})()</script>
