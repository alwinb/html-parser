<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tree Builder Test Page</title>
  <link rel="stylesheet" href="style/base.css">
  <link rel="stylesheet" href="style/tree.css">
  <!-- <script src="./scripts/console.js"></script> -->
  <script src="../dist/domex.min.js"></script>
</head>
<body>
  <!-- error notifications -->
  <script>(() => {
    const { domex } = window.modules.domex
    window.addEventListener ('error', showError)
    
    const dx = domex `
      div@error
        > h2.br0 %name ~error
        + a.link.close.fr[style="color:black"] "close"
        + div.hstack.p0 > (a.error.m0 [href=%href title=%url] "Â Â»Â " %message " ")*stack; // FIXME
    
      div.layer.error.notification.m4.pp6[style="background:#fffd"]
        > @error
    `

    function showError (e) {
      // const { domex } = window.modules.domex
      const stack = parseStack (e.error.stack || e.error+'')
      const obj = { message:e.message, url:e.filename, href:rewriteUrl (e.filename, e.lineno, e.colno).href, line:e.lineno, col:e.colno }
      stack.push (obj)
      const el = dx .render ({ error:e.error, message:e.message, stack }) .elem
      document.body.appendChild (el)
      el.querySelector ('.close') .onclick = () => el.remove ()
    }

  function parseStack (stack) {
    const r = []
    for (let sline of stack.split ('\n')) {
      let msg, line, col, url, _
      [msg, url] = (sline.split (/@?(?=\bfile:[/][/])/i)) // FF, Safari
      if (url) {
        [_, url, line, col] = /^(.*)[:](\d+)[:](\d+)$/.exec (url)
        r.push ({ message:msg, url, href:rewriteUrl (url, line, col).href, line, col })
      }
    }
    return r.reverse()
  }

  function rewriteUrl (url1, line = 1, column = 0) {
    const url = new URL (url1, document.baseURI)
    if (url.protocol === 'file:' || url.protocol === 'x-txmt-filehandle:') { // convert to txmt: URL
      callbackUrl = new URL ('txmt://open?')
      Object.entries ({ url, line, column }) .forEach (kv => callbackUrl.searchParams.set (...kv))
      return callbackUrl
    }
    Object.entries ({ line, column }) .forEach (kv => url.searchParams.set (...kv))
    return url1
  }

  })()</script>

<script src="../dist/html.min.js"></script>
<script src="./scripts/samples.js"></script>
<script src="./scripts/testui.js"></script>

<script>(()=>{
  const log = console.log.bind (console)

  // For debugging
  Object.defineProperty (Object.prototype, Symbol.toStringTag, {
    get: function () { return this.constructor.name }
  })

  // Tests
  // -----

  function* runTests () {
    const suites = window ['html-suites']
    let count = 0
    let time = 0
    let nativeTime = 0
    const failures = []
    
    const parser = new html.Parser
    for (let i=0, l= suites.length; i<l; i++) {
      const suite = suites[i]
      let suiteFailures = []
      for (const sample of suite.samples) {
        try {
          count ++
          const d1 = new Date
            const native = nativeParse (sample)
          const d2 = new Date
            nativeTime += (d2 - d1)
          const parsed = parser.parse (sample)
            time += (new Date - d2)
          if (printTree (native) !== printTree (parsed)) {
            failures.push (sample)
            suiteFailures.push (sample)
          }
        }
        catch (e) {
          // console.error ('Test threw:')
          // console.error (sample)
          failures.push (sample)
          suiteFailures.push (sample)
        }
      }
      if (suiteFailures.length) {
        suite.title = `(${suiteFailures.length}/${suite.samples.length}) ${suite.title}`
        suite.samples = suiteFailures
      }
      yield { failures, total:count, time, nativeTime }
    }
    return { failures, total:count, time, nativeTime }
  }


  // Main 
  // ----

  function main () {
    const { domex } = modules.domex

    // Set up Test UI

    const ui = new TestUI (window ['html-suites']) .showSuite (0)
    const todos = runTests ()

    function loop () {
      let start = new Date, done, results
      do {
        ({ value:results, done } = todos.next ())
        ui.showResults (results)
      }
      while (!done && new Date - start < 150)
      if (!done) return setTimeout (loop, 100)

      console.clear ()
      const { failures, total, time, nativeTime } = results

      window ['html-suites'] .unshift ({
        title: `ðŸž Failed ${Math.round (failures.length / total * 100)}% (${failures.length}/ ${total})`,
        samples: failures,
      })
      ui.update (window ['html-suites'])
      ui.showResults (results)
    }
    
    window.runAllTests = loop




    let sampleEl, suiteEl, inspEl // just quick..
    let inspected = null
    let pinned = false
    let tid = 0

    document.addEventListener ('mouseover', evt => {
      clearTimeout (tid)
      if (evt.target.className === 'label' && objectKey in evt.target.parentNode)
        tid = setTimeout (() => ui.inspect (evt.target.parentNode [objectKey]), 300)
      else if (!pinned)
        tid = setTimeout (() => ui.inspect (null), 300)
    })

    document.addEventListener ('click', evt => {
      if (evt.target.className === 'label' && objectKey in evt.target.parentNode) {
        inspected = evt.target.parentNode [objectKey]
        pinned = true
        ui.inspect (inspected)
        if (inspEl) inspEl.classList.remove ('selected')
        inspEl = evt.target
        inspEl.classList.add ('selected')
      }
      else {
        ui.inspect ((pinned = false, inspected = null))
        if (inspEl) inspEl.classList.remove ('selected')
        inspEl = null
      }
    })


    // Event handlers...
    document.addEventListener ('click', evt => {
      if (objectKey in evt.target) {
        ui.inspect (evt.target [objectKey])
        // pageConsole.write (domex `@default` .render (evt.target [objectKey]).elem)
        window.$ = evt.target [objectKey]
      }
      if ('key' in evt.target.dataset) {
        ui.showSample (+evt.target.dataset.key)
        if (sampleEl)
          sampleEl.classList.remove ('selected')
        evt.target.classList.add ('selected')
        sampleEl = evt.target
      }

      if ('suite' in evt.target.dataset) {
        ui.showSuite (+evt.target.dataset.suite)
        evt.target.classList.add ('selected')
        if (suiteEl)
          suiteEl.classList.remove ('selected')
        evt.target.classList.add ('selected')
        suiteEl = evt.target
      }
    })

    window.addEventListener ('keydown', evt => {
      if (evt.key === 'Enter' && evt.ctrlKey || evt.metaKey)
        ui.showSampleValue (input.value)
    })

    ui.focus ()
  }

 setTimeout (main)
})()</script>
