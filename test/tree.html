<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tree Builder Test Page</title>
  <link rel="stylesheet" href="style/base.css">
  <link rel="stylesheet" href="style/tree.css">
  <script src="./scripts/console.js"></script>
</head>
<body>

<script>
  window.pageConsole = window.console = new Console ()
  document.body.append (console.elem)
  window.addEventListener ('error', evt => console.errorHandler (evt), true)
</script>

<script src="../dist/html.js"></script>
<script src="../dist/domex.min.js"></script>
<script src="./scripts/samples.js"></script>
<script src="./scripts/testui.js"></script>

<script>(()=>{

  const log = console.log.bind (console)

  // For debugging
  Object.defineProperty (Object.prototype, Symbol.toStringTag, {
    get: function () { return this.constructor.name }
  })


  // Tests
  // -----

  function runTests () {
    const suites = window ['html-suites']
    let count = 0
    let time = 0
    let nativeTime = 0
    const failures = []
    for (const suite of suites) {
      for (const sample of suite.samples) {
        try {
          count ++
          const d1 = new Date
            const native = nativeParse (sample)
          const d2 = new Date
            nativeTime += (d2 - d1)
          const parsed = html.parse (sample)
            time += (new Date - d2)
          if (printTree (native) !== printTree (parsed))
            failures.push (sample)
        }
        catch (e) {
          // console.error ('Test threw:')
          // console.error (sample)
          failures.push (sample)
        }
      }
    }
    return { failures, total:count, time, nativeTime }
  }

  // Main 
  // ----

  function main () {
    const { domex } = modules.domex

    // Run all samples
    const results = runTests ()
    const { failures, total, time, nativeTime } = results
    

    window ['html-suites'] .unshift ({
      title: `🐞 Failures: ${Math.round (failures.length / total * 100)}% (${failures.length} / ${total})`,
      samples: failures,
    })

    // Set up Test UI

    const ui = new TestUI () .showSuite (0)
    ui.showResults (results)

    const submit = byId ('submit')
    submit .addEventListener ('click', evt => {
      ui.showSampleValue (input.value)
    })

    document.addEventListener ('mouseover', evt => {
      if (evt.target.className === 'label' && objectKey in evt.target.parentNode) {
        ui.inspect (evt.target.parentNode [objectKey])
        // pageConsole.write (domex `@default` .render (evt.target [objectKey]).elem)
      }
      else 
        ui.inspect (null)
    })

    // Event handlers...
    document.addEventListener ('click', evt => {
      if (objectKey in evt.target) {
        ui.inspect (evt.target [objectKey])
        // pageConsole.write (domex `@default` .render (evt.target [objectKey]).elem)
        window.$ = evt.target [objectKey]
      }
      if ('key' in evt.target.dataset)
        ui.showSample (+evt.target.dataset.key)

      if ('suite' in evt.target.dataset)
        ui.showSuite (+evt.target.dataset.suite)

    })

    window.addEventListener ('keydown', evt => {
      if (evt.key === 'Enter' && evt.ctrlKey || evt.metaKey)
        ui.showSampleValue (input.value)
    })

    ui.focus ()
  }

 setTimeout (main)
})()</script>
