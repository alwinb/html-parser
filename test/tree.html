<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tree Builder Test Page</title>
  <link rel="stylesheet" href="style/base.css">
  <link rel="stylesheet" href="style/tree.css">
  <script src="./scripts/console.js"></script>
</head>
<body>

<h1>Dom viewer</h1>

<p>This is a test page for the HTML parser,

<ul id=tabs>
</ul>
<textarea id=input>
</textarea>
<button id=submit>Run</button>

<div id=view1 class=DomTree>
  Browser
</div>

<div id=view2 class=DomTree>
  Html Parser
</div>

<script>
  window.console = new Console ()
  document.body.append (console.elem)
  window.addEventListener ('error', evt => console.errorHandler (evt), true)
</script>

<script src="../dist/html.js"></script>
<script>(()=>{
  const { html } = modules
  const T = html.tokenTypes
  const $ = name => document.createElement (name)
  const log = console.log.bind (console)
  log (T)

  const setProps = (el, props) => {
    for (let k in props) el.setAttribute (k, props[k])
  }

  Object.defineProperty (Object.prototype, Symbol.toStringTag, { get:function () { return this.constructor.name } })

  // OK lets create the tree
  // MDN: In addition, every kind of DOM node is represented by an interface based on Node. These include Attr, CharacterData (which Text, Comment, and CDATASection are all based on), ProcessingInstruction, DocumentType, Notation, Entity, and EntityReference.

  function nativeParse (input) {
    return new DOMParser () .parseFromString (input, 'text/html')
  }

  function makeTabs (samples) {
    const ul = document.getElementById ('tabs')
    let li, i = 0
    for (let x of samples) { let li
      ul.append((li = $('li')))
      li.className = '-button'
      li.append('Sample '+ (++i))
      li.onclick = _ => showSample (x)
    }
    return ul
  }
  document.getElementById ('submit') .addEventListener ('click', evt => {
    showSample (document.getElementById ('input').value)
  })


  const objectKey = Symbol ()
  const htmlns = 'http://www.w3.org/1999/xhtml'

  function showTree (domNode) {
    let elem, label, clss

    if (domNode instanceof Text) {
      clss = (/^\s*$/.test (domNode.data)) ? 'space' : 'text'
      elem = $('span')
      elem.append (domNode.data)
      elem.className = clss
      elem[objectKey] = domNode
      return elem
    }
    if (typeof domNode === 'string') {
      clss = (/^\s*$/.test (domNode)) ? 'space' : 'text'
      elem = $('span')
      elem.append (domNode)
      elem.className = clss
      elem[objectKey] = domNode
      return elem
    }

    elem = $('div')
    if (domNode instanceof Document || domNode instanceof html.Document)
      label = '#document'

    else if (domNode instanceof Comment || domNode[0] === T.Comment)
      label = '<!-->'

    else if (domNode instanceof Element || domNode instanceof html.Node || domNode instanceof html.Leaf || domNode[0] === T.FormatTag) {
      label = (domNode.tagName||domNode.name).toLowerCase ()
      if (domNode.namespaceURI && domNode.namespaceURI !== htmlns)
        label = domNode.namespaceURI.split('/').pop () + ':' + label
    }
    else if (domNode[0] === T.FormatEndTag)
      label = '/'+domNode.name

    // log (domNode.__proto__)
    elem.append (label)
    elem[objectKey] = domNode
    
    if (clss) elem.classList.add(clss)
    let ul; elem.append ((ul = $('div')))
    ul.className = 'children'

    const children = domNode instanceof HTMLTemplateElement ?
      domNode.content.childNodes : domNode.childNodes || domNode.children || []
    for (let x of children) {
      ul.append (showTree (x))
    }
    return elem
  }

  function showSample (sample) {
    const [input, view1, view2] = ['input', 'view1', 'view2'].map (_ => document.getElementById (_))
    input.value = sample
    view1.innerHTML = view2.innerHTML = ''
    view1.append (showTree (nativeParse (sample)))
    view2.append (showTree (html.parse (sample)))
  }
  document.addEventListener ('click', evt => {
    if (objectKey in evt.target)
      log (evt.target[objectKey])
  })

  var samples = [
    `<ul><li><applet><as></li>test</ul>
<ul><li><p><as></li>test`, // FIXME, this has to do with the 'active formating elements...', incorrect only for applet, marquee, object, may be?
    `<p>Test<h1>Head<div><h2>`, // FIXME
    `<p>para<object>and<p>para`, // FIXME
    `<p>Test<h1>Head<button><h2>`, // FIXME
    `<table><td><p>Test<h1>Head<button><td><h2>`, // FIXME
    `<p>Test<h1>Head`,
    `<table><td><p>Test<blockquote>Foo<p>bar<td>`,
    `<p>Test<li>li<blockquote>Foo<p>bar<p>`,
    `<table><td>foo<button>one<button><p>two<button>three<td>cell`,
    `<p><foo><li>`,
    `<svg><big><rect></svg>`,
    `<tr><b>bold<i>italic<li></b>`,
    `<svg><path>text<bar>Foo<p>Test<rect></body><!--->`,

    // NB parsed differently in Firefox
    `Test nesting of option and optgroup.
    <select>Foo<textarea>Bar</textarea>
    <select>Foo<input>
    <select>Foo<keygen>
    <select>Foo<option>Bar<option>Baz<optgroup>Baz<option>Bee<select>Baz<optgroup>Item<li>item<optgroup>g<di>Di</select>
    `,
    
    // `<option>Item<li>item<di><option><select><option>Item<li>item<di><option><select>`,
    // `<option>Item<li>item<di><option>Item2<li>item<di><option><select><option>Item<li>item<di><option><option>Item2<li><optgroup>item<di>`,

    `Hello`,
    `<body>Hello`,
    `<script>fn</`+`script>Hello`,
    `<table><td>foo<tr><td>bar<col>`, 
    `<br>`, 

    `Test close by cell
    <table><colgroup><td>cell1<td>cell2`,

    `Test close by cell (2)
    <template><colgroup><td>cell1<td>cell2`,

    ]
  
  makeTabs(samples)
  showSample(samples[0])

})()</script>
